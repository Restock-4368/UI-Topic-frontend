import{D as N,E as Q}from"./delete.component-BYcoWo1i.js";import{B as T}from"./base-modal.component-CHnwFR1t.js";import{_ as x,E as j,c as S,a as _,z as A,g as p,o as u,L as I,M as L,d as h,b as n,F as k,j as D,e as R,t as m,n as B,f as a,N as F,i as V}from"./index-BDkOpPWW.js";import{S as P}from"./supply.service-CNYI0_eD.js";import{S as O}from"./supply.assembler-CSpomLG2.js";import{R as z,a as G}from"./recipe-supply.service-CvMwEzNQ.js";const H={name:"CreateAndEdit",components:{PvButton:j,BaseModal:T},props:{modelValue:{type:Boolean,required:!0},mode:{type:String,default:"create"},createTitle:{type:String,default:"Create"},editTitle:{type:String,default:"Edit"}},emits:["update:modelValue","close","save"],computed:{internalVisible:{get(){return this.modelValue},set(i){this.$emit("update:modelValue",i)}}}};function Y(i,e,l,c,t,o){const d=p("BaseModal");return u(),S(d,{modelValue:o.internalVisible,"onUpdate:modelValue":e[0]||(e[0]=y=>o.internalVisible=y),title:l.mode==="create"?l.createTitle:l.editTitle,onClose:e[1]||(e[1]=y=>i.$emit("close"))},{default:_(()=>[A(i.$slots,"default")]),_:3},8,["modelValue","title"])}const J=x(H,[["render",Y]]),K={name:"AddAndEditForm",components:{PvInputNumber:L,PvInputText:I},props:{schema:{type:Array,required:!0},initialData:{type:Object,default:()=>({})},mode:{type:String,default:"create"}},emits:["submit"],data(){return{form:{...this.initialData},errors:{}}},watch:{initialData:{handler(i){this.form={...i},this.errors={}},deep:!0}},methods:{validate(){const i={};return this.schema.forEach(e=>{const l=this.form[e.name];e.type==="number"?(l==null||l===""||Number(l)<=0)&&(i[e.name]="Required"):e.type!=="boolean"&&(!l||l.toString().trim()==="")&&(i[e.name]="Required")}),this.errors=i,Object.keys(i).length===0},handleSubmit(){this.validate()&&this.$emit("submit",this.form)},handleUpload(i,e){const l=i.files[0];console.log("Upload triggered:",i.files),console.log("Sending to Cloudinary:"),console.log("Upload preset:","uitopic"),console.log("File:",l.name);const c=new FormData;c.append("file",l),c.append("upload_preset","uitopic"),fetch("https://api.cloudinary.com/v1_1/dvspiemtu/image/upload",{method:"POST",body:c}).then(t=>t.json()).then(t=>{console.log("Image uploaded:",t.secure_url),this.form[e]=t.secure_url}).catch(t=>{console.error("Upload failed:",t)})}}},W=["for"],X={key:4,class:"mt-3"},Z=["src"],$={key:5,class:"p-error"},ee={class:"flex justify-content-end mt-4"};function te(i,e,l,c,t,o){const d=p("pv-input-text"),y=p("pv-input-number"),f=p("pv-input-switch"),v=p("FileUpload"),g=p("pv-button");return u(),h("form",{onSubmit:e[0]||(e[0]=F((...s)=>o.handleSubmit&&o.handleSubmit(...s),["prevent"]))},[(u(!0),h(k,null,D(l.schema,s=>(u(),h("div",{key:s.name,class:"p-field mb-3"},[n("label",{for:s.name,class:"block mb-1"},m(s.label),9,W),s.type==="text"?(u(),S(d,{key:0,modelValue:t.form[s.name],"onUpdate:modelValue":b=>t.form[s.name]=b,id:s.name,placeholder:s.placeholder,class:B(["w-full",{"p-invalid":t.errors[s.name]}])},null,8,["modelValue","onUpdate:modelValue","id","placeholder","class"])):s.type==="number"?(u(),S(y,{key:1,modelValue:t.form[s.name],"onUpdate:modelValue":b=>t.form[s.name]=b,id:s.name,placeholder:s.placeholder,mode:s.format==="currency"?"currency":"decimal",currency:s.format==="currency"?"PEN":null,locale:"es-PE",useGrouping:!0,minFractionDigits:s.format==="currency"?2:0,maxFractionDigits:s.format==="currency"?2:0,class:B(["w-full",{"p-invalid":t.errors[s.name]}])},null,8,["modelValue","onUpdate:modelValue","id","placeholder","mode","currency","minFractionDigits","maxFractionDigits","class"])):s.type==="boolean"?(u(),S(f,{key:2,modelValue:t.form[s.name],"onUpdate:modelValue":b=>t.form[s.name]=b,id:s.name},null,8,["modelValue","onUpdate:modelValue","id"])):R("",!0),s.type==="file"?(u(),S(v,{key:3,name:"file",mode:"basic",customUpload:"",auto:"",accept:"image/*",class:"green-button",onUploader:b=>o.handleUpload(b,s.name)},null,8,["onUploader"])):R("",!0),s.type==="file"&&t.form[s.name]?(u(),h("div",X,[n("img",{src:t.form[s.name],alt:"Preview",style:{"max-width":"100%","border-radius":"10px"}},null,8,Z)])):R("",!0),t.errors[s.name]?(u(),h("small",$,m(t.errors[s.name]),1)):R("",!0)]))),128)),A(i.$slots,"extension",{form:t.form}),n("div",ee,[a(g,{label:l.mode==="create"?"Save":"Update",icon:"pi pi-check",type:"submit",class:"green-button"},null,8,["label"])])],32)}const ie=x(K,[["render",te]]),se={name:"SupplySelector",props:{modelValue:{type:Array,default:()=>[]}},emits:["update:modelValue"],data(){return{availableSupplies:[],selectedSupply:null,selectedQuantity:null,internalValue:[...this.modelValue||[]]}},watch:{internalValue:{handler(i){this.$emit("update:modelValue",i)},deep:!0}},computed:{supplies:{get(){return this.modelValue},set(i){this.$emit("update:modelValue",i)}}},async created(){const e=await new P().getAll();this.availableSupplies=O.toEntitiesFromResponse(e)},methods:{addSupply(){!this.internalValue.some(e=>{var l;return e.supply_id===((l=this.selectedSupply)==null?void 0:l.id)})&&this.selectedQuantity>0&&this.internalValue.push({supply_id:this.selectedSupply.id,quantity:this.selectedQuantity}),this.selectedSupply=null,this.selectedQuantity=null},removeSupply(i){this.internalValue.splice(i,1)},getSupplyName(i){const e=this.availableSupplies.find(l=>l.id===i);return e?e.name:"Unknown"}}},le={class:"supply-selector"},oe={class:"flex align-items-center gap-2 mb-3"};function ne(i,e,l,c,t,o){const d=p("pv-select"),y=p("pv-input-number"),f=p("pv-button"),v=p("pv-column"),g=p("pv-data-table");return u(),h("div",le,[n("div",oe,[a(d,{modelValue:t.selectedSupply,"onUpdate:modelValue":e[0]||(e[0]=s=>t.selectedSupply=s),options:t.availableSupplies,placeholder:"Select supply",class:"w-full"},{option:_(({option:s})=>[V(m(s.name),1)]),value:_(({value:s})=>[V(m((s==null?void 0:s.name)||"Select supply"),1)]),_:1},8,["modelValue","options"]),a(y,{modelValue:t.selectedQuantity,"onUpdate:modelValue":e[1]||(e[1]=s=>t.selectedQuantity=s),placeholder:"Qty",class:"w-6rem",inputClass:"w-full"},null,8,["modelValue"]),a(f,{icon:"pi pi-plus-circle",onClick:o.addSupply,class:"green-button",disabled:!t.selectedSupply||!t.selectedQuantity||t.selectedQuantity<=0},null,8,["onClick","disabled"])]),a(g,{value:t.internalValue,class:"w-full"},{default:_(()=>[a(v,{field:"supply_id",header:"ID"}),a(v,{field:"description",header:"Supply"},{body:_(s=>[V(m(o.getSupplyName(s.data.supply_id)),1)]),_:1}),a(v,{field:"quantity",header:"Quantity"}),a(v,{header:"Actions"},{body:_(s=>[a(f,{icon:"pi pi-trash",onClick:b=>o.removeSupply(s.index),severity:"danger",text:""},null,8,["onClick"])]),_:1})]),_:1},8,["value"])])}const re=x(se,[["render",ne]]);class ae{constructor({id:e,name:l,description:c,total_price:t,image_url:o,user_id:d}){this.id=e,this.name=l,this.description=c,this.total_price=t,this.image_url=o,this.user_id=d}}class C{static toEntityFromResource(e){return new ae({...e})}static toEntitiesFromResponse(e){return(Array.isArray(e.data)?e.data:e.data.recipes||[]).map(c=>this.toEntityFromResource(c))}static toEntityFromResponse(e){return!e||!e.data?null:this.toEntityFromResource(e.data)}}class pe{constructor(e){this.id=e.id,this.recipe_id=e.recipe_id,this.supply_id=e.supply_id,this.quantity=e.quantity}getQuantityLabel(){return`${this.quantity} unit(s)`}}class E{static toEntity(e){return new pe(e)}static toEntities(e){return e.map(l=>this.toEntity(l))}static toEntitiesFromResponse(e){return this.toEntities(e.data)}static toEntityFromResponse(e){return this.toEntity(e.data)}}const ce={name:"RestaurantRecipesOverview",components:{EmptySection:Q,CreateAndEdit:J,AddAndEditForm:ie,DeleteConfirmation:N,SupplySelector:re},data(){return{recipes:[],search:"",formVisible:!1,editMode:"create",formModel:{},selectedRecipe:null,deleteVisible:!1,recipeService:new G,sortByPrice:!1,recipeSupplyService:new z,detailsVisible:!1,supplyService:new P,allSupplies:[]}},computed:{filteredRecipes(){let i=this.recipes.filter(e=>e.name.toLowerCase().includes(this.search.toLowerCase()));return this.sortByPrice?i.sort((e,l)=>e.total_price-l.total_price):i},formSchema(){return[{name:"name",label:"Name",type:"text",placeholder:"Recipe name"},{name:"description",label:"Description",type:"text",placeholder:"Short description"},{name:"total_price",label:"Total Price (S/.)",type:"number",placeholder:"e.g. 29.90",format:"currency"},{name:"image_url",label:"Dish Image",placeholder:"Upload an image",type:"file"}]}},async created(){this.allSupplies=await this.loadAllSupplies(),await this.loadRecipes()},methods:{async loadAllSupplies(){return(await this.supplyService.getAll()).data},async loadRecipes(){const i=await this.recipeService.getAll(),e=C.toEntitiesFromResponse(i),l=await Promise.all(e.map(async c=>{const t=await this.recipeSupplyService.getByRecipe(c.id),o=E.toEntitiesFromResponse(t);return{...c,supplies:o}}));this.recipes=l},openCreateDialog(){this.editMode="create",this.formModel={supplies:[],user_id:1},this.formVisible=!0},async openEditDialog(i){const e=await this.recipeSupplyService.getByRecipe(i.id),l=E.toEntitiesFromResponse(e);this.formModel={...i,supplies:l},this.editMode="edit",this.formVisible=!0},closeForm(){this.formVisible=!1},async submitForm(i){try{if(this.editMode==="create"){const e=await this.recipeService.create(i),l=C.toEntityFromResource(e),c=i.supplies.map(o=>{var d;return{supply_id:((d=o.supply)==null?void 0:d.id)||o.supply_id,quantity:o.quantity}});await this.recipeSupplyService.bulkCreate(l.id,c);const t=c.map(o=>{const d=this.allSupplies.find(y=>y.id===o.supply_id);return{...o,supply:d}});this.recipes.push({...l,supplies:t}),await this.loadRecipes()}else{await this.recipeSupplyService.deleteByRecipe(i.id);const e=i.supplies.filter(l=>l.supply&&l.supply.id).map(l=>({supply_id:l.supply.id,quantity:l.quantity}));await this.recipeSupplyService.bulkCreate(i.id,e),await this.recipeService.update(i.id,i),await this.loadRecipes()}this.closeForm()}catch(e){console.error("Error al guardar la receta:",e),this.$toast.add({severity:"error",summary:"Error",detail:"No se pudo guardar la receta",life:3e3})}},openDeleteDialog(i){this.selectedRecipe=i,this.deleteVisible=!0},async confirmDelete(){await this.recipeService.delete(this.selectedRecipe.id),await this.recipeSupplyService.deleteByRecipe(this.selectedRecipe.id),this.deleteVisible=!1,this.selectedRecipe=null,await this.loadRecipes()},async recipeDetails(i){const e=await this.recipeService.getById(i.id),l=C.toEntityFromResponse(e),c=await this.recipeSupplyService.getByRecipe(i.id),o=E.toEntitiesFromResponse(c).map(d=>{const y=this.allSupplies.find(f=>f.id===d.supply_id);return{...d,supply:y}});this.selectedRecipe={...l,supplies:o},this.detailsVisible=!0}}},ue={class:"recipes-view p-4"},de={class:"recipes-header flex flex-column sm:flex-row justify-content-between sm:align-items-center flex-wrap gap-3 sm:gap-4 mb-4"},me={class:"recipes-header__top"},ye={class:"text-2xl font-semibold mr-2"},he={class:"recipes-header__middle flex flex-row flex-wrap align-items-center gap-2 sm:gap-5"},_e={class:"flex align-items-center gap-2"},fe={class:"recipes-header__actions"},be={key:1,class:"recipes-grid"},ve=["onClick"],Se=["src"],ge={class:"recipe-card__actions"},Ve={class:"flex flex-column gap-4 overflow-y-auto",style:{"max-height":"75vh",padding:"1rem"}},we={class:"flex justify-content-between align-items-center border-bottom-1 surface-border pb-2"},Re={class:"m-0 text-xl font-bold"},xe={class:"text-xl text-color-secondary"},Ce={class:"w-full border-round overflow-hidden shadow-1"},Ee=["src"],ke={class:"text-sl line-height-3 text-color-primary m-0"},De={class:"pl-3 m-0"};function Fe(i,e,l,c,t,o){var U;const d=p("pv-input-text"),y=p("pv-input-switch"),f=p("pv-button"),v=p("empty-section"),g=p("SupplySelector"),s=p("add-and-edit-form"),b=p("create-and-edit"),M=p("DeleteConfirmation"),q=p("pv-dialog");return u(),h("div",ue,[n("div",de,[n("div",me,[n("h2",ye,m(i.$t("recipes.title")),1)]),n("div",he,[a(d,{modelValue:t.search,"onUpdate:modelValue":e[0]||(e[0]=r=>t.search=r),placeholder:"Search recipes...",class:"w-full sm:w-30rem"},null,8,["modelValue"]),n("div",_e,[e[6]||(e[6]=n("label",{for:"sortByPrice",class:"text-sm text-color-secondary"},"Sort by price",-1)),a(y,{modelValue:t.sortByPrice,"onUpdate:modelValue":e[1]||(e[1]=r=>t.sortByPrice=r),inputId:"sortByPrice"},null,8,["modelValue"])])]),n("div",fe,[a(f,{label:"Create",icon:"pi pi-plus-circle",onClick:o.openCreateDialog,class:"green-button w-full sm:w-auto font-semibold px-3 py-2"},null,8,["onClick"])])]),o.filteredRecipes.length===0?(u(),S(v,{key:0},{icon:_(()=>e[7]||(e[7]=[n("i",{class:"pi pi-clipboard",style:{"font-size":"3rem",color:"#bcbcbc"}},null,-1)])),default:_(()=>[e[8]||(e[8]=V(" You currently have no recipes registered. Create a new recipe to start organizing your preparations and better manage your ingredients from this section. "))]),_:1})):(u(),h("div",be,[(u(!0),h(k,null,D(o.filteredRecipes,r=>(u(),h("div",{key:r.id,class:"recipe-card",onClick:w=>o.recipeDetails(r)},[n("img",{src:r.image_url,alt:"Dish image"},null,8,Se),n("h3",null,m(r.name),1),n("p",null,"Total cost: S/."+m(r.total_price),1),n("div",ge,[a(f,{icon:"pi pi-pencil",onClick:F(w=>o.openEditDialog(r),["stop"]),outlined:""},null,8,["onClick"]),a(f,{icon:"pi pi-trash",severity:"danger",onClick:F(w=>o.openDeleteDialog(r),["stop"]),outlined:""},null,8,["onClick"])])],8,ve))),128))])),a(b,{modelValue:t.formVisible,"onUpdate:modelValue":e[2]||(e[2]=r=>t.formVisible=r),mode:t.editMode,createTitle:"Create Recipe",editTitle:"Edit Recipe",onClose:o.closeForm},{default:_(()=>[a(s,{schema:o.formSchema,initialData:t.formModel,mode:t.editMode,onSubmit:o.submitForm},{extension:_(({form:r})=>[e[9]||(e[9]=n("h4",{class:"mt-4 mb-2"},"Recipe Supplies",-1)),a(g,{modelValue:r.supplies,"onUpdate:modelValue":w=>r.supplies=w},null,8,["modelValue","onUpdate:modelValue"])]),_:1},8,["schema","initialData","mode","onSubmit"])]),_:1},8,["modelValue","mode","onClose"]),a(M,{modelValue:t.deleteVisible,"onUpdate:modelValue":e[3]||(e[3]=r=>t.deleteVisible=r),label:(U=t.selectedRecipe)==null?void 0:U.name,onConfirm:o.confirmDelete,onCancel:e[4]||(e[4]=r=>t.deleteVisible=!1)},null,8,["modelValue","label","onConfirm"]),a(q,{visible:t.detailsVisible,"onUpdate:visible":e[5]||(e[5]=r=>t.detailsVisible=r),modal:"",style:{width:"600px",maxHeight:"90vh"},closable:!0},{default:_(()=>[n("div",Ve,[n("div",we,[n("h3",Re,m(t.selectedRecipe.name),1),n("span",xe,"S/. "+m(t.selectedRecipe.total_price),1)]),n("div",Ce,[n("img",{src:t.selectedRecipe.image_url,alt:"Recipe image",class:"w-full",style:{"max-height":"250px","object-fit":"cover"}},null,8,Ee)]),n("p",ke,m(t.selectedRecipe.description),1),n("div",null,[e[11]||(e[11]=n("h4",{class:"text-md font-medium mb-2"},"Supplies",-1)),n("ul",De,[(u(!0),h(k,null,D(t.selectedRecipe.supplies,r=>(u(),h("li",{key:r.supply.id,class:"mb-1 text-sm"},[e[10]||(e[10]=n("i",{class:"pi pi-food mr-2 text-primary"},null,-1)),V(" "+m(r.supply.name)+" â€“ "+m(r.quantity)+" unit(s) ",1)]))),128))])])])]),_:1},8,["visible"])])}const Ne=x(ce,[["render",Fe],["__scopeId","data-v-2a4dc024"]]);export{Ne as default};
