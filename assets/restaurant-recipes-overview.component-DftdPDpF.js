import{D as M,E as A}from"./delete.component-Ccf8oAtn.js";import{B as P}from"./base-modal.component-Bk1cDjre.js";import{_ as w,E as T,c as S,a as m,z as F,g as a,o as c,L as I,M as N,d as _,b as p,F as U,j as k,e as C,t as v,f as n,N as Q,i as V}from"./index-InIZ-6yY.js";import{S as q}from"./supply.service-C0sQ-XRc.js";import{S as O}from"./supply.assembler-CSpomLG2.js";import{R as j,a as L}from"./recipe-supply.service-BDDEiXrf.js";const z={name:"CreateAndEdit",components:{PvButton:T,BaseModal:P},props:{modelValue:{type:Boolean,required:!0},mode:{type:String,default:"create"},createTitle:{type:String,default:"Create"},editTitle:{type:String,default:"Edit"}},emits:["update:modelValue","close","save"],computed:{internalVisible:{get(){return this.modelValue},set(t){this.$emit("update:modelValue",t)}}}};function G(t,e,s,u,i,o){const y=a("BaseModal");return c(),S(y,{modelValue:o.internalVisible,"onUpdate:modelValue":e[0]||(e[0]=h=>o.internalVisible=h),title:s.mode==="create"?s.createTitle:s.editTitle,onClose:e[1]||(e[1]=h=>t.$emit("close"))},{default:m(()=>[F(t.$slots,"default")]),_:3},8,["modelValue","title"])}const Y=w(z,[["render",G]]),H={name:"AddAndEditForm",components:{PvInputNumber:N,PvInputText:I},props:{schema:{type:Array,required:!0},initialData:{type:Object,default:()=>({})},mode:{type:String,default:"create"}},emits:["submit"],data(){return{form:{...this.initialData}}},methods:{handleUpload(t,e){const s=t.files[0];console.log("ðŸ“ Upload triggered:",t.files),console.log("ðŸ§ª Sending to Cloudinary:"),console.log("Upload preset:","uitopic"),console.log("File:",s.name);const u=new FormData;u.append("file",s),u.append("upload_preset","uitopic"),fetch("https://api.cloudinary.com/v1_1/dvspiemtu/image/upload",{method:"POST",body:u}).then(i=>i.json()).then(i=>{console.log("Image uploaded:",i.secure_url),this.form[e]=i.secure_url}).catch(i=>{console.error("Upload failed:",i)})}}},J=["for"],K={key:4,class:"mt-3"},W=["src"],X={class:"flex justify-content-end mt-4"};function Z(t,e,s,u,i,o){const y=a("pv-input-text"),h=a("pv-input-number"),f=a("pv-input-switch"),b=a("FileUpload"),g=a("pv-button");return c(),_("form",{onSubmit:e[0]||(e[0]=Q(l=>t.$emit("submit",i.form),["prevent"]))},[(c(!0),_(U,null,k(s.schema,l=>(c(),_("div",{key:l.name,class:"p-field mb-3"},[p("label",{for:l.name,class:"block mb-1"},v(l.label),9,J),l.type==="text"?(c(),S(y,{key:0,modelValue:i.form[l.name],"onUpdate:modelValue":d=>i.form[l.name]=d,id:l.name,placeholder:l.placeholder,class:"w-full"},null,8,["modelValue","onUpdate:modelValue","id","placeholder"])):l.type==="number"?(c(),S(h,{key:1,modelValue:i.form[l.name],"onUpdate:modelValue":d=>i.form[l.name]=d,id:l.name,placeholder:l.placeholder,mode:l.format==="currency"?"currency":"decimal",currency:l.format==="currency"?"PEN":null,locale:"es-PE",useGrouping:!0,minFractionDigits:l.format==="currency"?2:0,maxFractionDigits:l.format==="currency"?2:0,class:"w-full"},null,8,["modelValue","onUpdate:modelValue","id","placeholder","mode","currency","minFractionDigits","maxFractionDigits"])):l.type==="boolean"?(c(),S(f,{key:2,modelValue:i.form[l.name],"onUpdate:modelValue":d=>i.form[l.name]=d,id:l.name},null,8,["modelValue","onUpdate:modelValue","id"])):C("",!0),l.type==="file"?(c(),S(b,{key:3,name:"file",mode:"basic",customUpload:"",auto:"",accept:"image/*",class:"green-button",onUploader:d=>o.handleUpload(d,l.name)},null,8,["onUploader"])):C("",!0),l.type==="file"&&i.form[l.name]?(c(),_("div",K,[p("img",{src:i.form[l.name],alt:"Preview",style:{"max-width":"100%","border-radius":"10px"}},null,8,W)])):C("",!0)]))),128)),F(t.$slots,"extension",{form:i.form}),p("div",X,[n(g,{label:s.mode==="create"?"Save":"Update",icon:"pi pi-check",type:"submit",class:"green-button"},null,8,["label"])])],32)}const $=w(H,[["render",Z]]),ee={name:"SupplySelector",props:{modelValue:{type:Array,default:()=>[]}},emits:["update:modelValue"],data(){return{availableSupplies:[],selectedSupply:null,selectedQuantity:null,internalValue:[...this.modelValue||[]]}},watch:{internalValue:{handler(t){this.$emit("update:modelValue",t)},deep:!0}},computed:{supplies:{get(){return this.modelValue},set(t){this.$emit("update:modelValue",t)}}},async created(){const e=await new q().getAll();this.availableSupplies=O.toEntitiesFromResponse(e)},methods:{addSupply(){this.internalValue.some(e=>{var s;return e.supply_id===((s=this.selectedSupply)==null?void 0:s.id)})||this.internalValue.push({supply_id:this.selectedSupply.id,quantity:this.selectedQuantity}),this.selectedSupply=null,this.selectedQuantity=null},removeSupply(t){this.internalValue.splice(t,1)},getSupplyName(t){const e=this.availableSupplies.find(s=>s.id===t);return e?e.name:"Unknown"}}},te={class:"supply-selector"},ie={class:"flex align-items-center gap-2 mb-3"};function le(t,e,s,u,i,o){const y=a("pv-select"),h=a("pv-input-number"),f=a("pv-button"),b=a("pv-column"),g=a("pv-data-table");return c(),_("div",te,[p("div",ie,[n(y,{modelValue:i.selectedSupply,"onUpdate:modelValue":e[0]||(e[0]=l=>i.selectedSupply=l),options:i.availableSupplies,placeholder:"Select supply",class:"w-full"},{option:m(({option:l})=>[V(v(l.name),1)]),value:m(({value:l})=>[V(v((l==null?void 0:l.name)||"Select supply"),1)]),_:1},8,["modelValue","options"]),n(h,{modelValue:i.selectedQuantity,"onUpdate:modelValue":e[1]||(e[1]=l=>i.selectedQuantity=l),placeholder:"Qty",class:"w-6rem",inputClass:"w-full"},null,8,["modelValue"]),n(f,{icon:"pi pi-plus-circle",onClick:o.addSupply,class:"green-button",disabled:!i.selectedSupply||!i.selectedQuantity},null,8,["onClick","disabled"])]),n(g,{value:i.internalValue,class:"w-full"},{default:m(()=>[n(b,{field:"supply_id",header:"ID"}),n(b,{field:"description",header:"Supply"},{body:m(l=>[V(v(o.getSupplyName(l.data.supply_id)),1)]),_:1}),n(b,{field:"quantity",header:"Quantity"}),n(b,{header:"Actions"},{body:m(l=>[n(f,{icon:"pi pi-trash",onClick:d=>o.removeSupply(l.index),severity:"danger",text:""},null,8,["onClick"])]),_:1})]),_:1},8,["value"])])}const se=w(ee,[["render",le]]);class oe{constructor({id:e,name:s,description:u,total_price:i,image_url:o,user_id:y}){this.id=e,this.name=s,this.description=u,this.total_price=i,this.image_url=o,this.user_id=y}}class E{static toEntityFromResource(e){return new oe({...e})}static toEntitiesFromResponse(e){return(Array.isArray(e.data)?e.data:e.data.recipes||[]).map(u=>this.toEntityFromResource(u))}static toEntityFromResponse(e){return!e||!e.data?null:this.toEntityFromResource(e.data)}}class ne{constructor(e){this.id=e.id,this.recipe_id=e.recipe_id,this.supply_id=e.supply_id,this.quantity=e.quantity}getQuantityLabel(){return`${this.quantity} unit(s)`}}class D{static toEntity(e){return new ne(e)}static toEntities(e){return e.map(s=>this.toEntity(s))}static toEntitiesFromResponse(e){return this.toEntities(e.data)}static toEntityFromResponse(e){return this.toEntity(e.data)}}const ae={name:"RestaurantRecipesOverview",components:{EmptySection:A,CreateAndEdit:Y,AddAndEditForm:$,DeleteConfirmation:M,SupplySelector:se},data(){return{recipes:[],search:"",formVisible:!1,editMode:"create",formModel:{},selectedRecipe:null,deleteVisible:!1,recipeService:new L,sortByPrice:!1,recipeSupplyService:new j}},computed:{filteredRecipes(){let t=this.recipes.filter(e=>e.name.toLowerCase().includes(this.search.toLowerCase()));return this.sortByPrice?t.sort((e,s)=>e.total_price-s.total_price):t},formSchema(){return[{name:"name",label:"Name",type:"text",placeholder:"Recipe name"},{name:"description",label:"Description",type:"text",placeholder:"Short description"},{name:"total_price",label:"Total Price (S/.)",type:"number",placeholder:"e.g. 29.90",format:"currency"},{name:"image_url",label:"Dish Image",placeholder:"Upload an image",type:"file"}]}},created(){this.loadRecipes()},methods:{async loadRecipes(){const t=await this.recipeService.getAll(),e=E.toEntitiesFromResponse(t),s=await Promise.all(e.map(async u=>{const i=await this.recipeSupplyService.getByRecipe(u.id),o=D.toEntitiesFromResponse(i);return{...u,supplies:o}}));this.recipes=s},openCreateDialog(){this.editMode="create",this.formModel={supplies:[],user_id:1},this.formVisible=!0},async openEditDialog(t){const e=await this.recipeSupplyService.getByRecipe(t.id),s=D.toEntitiesFromResponse(e);this.formModel={...t,supplies:s},this.editMode="edit",this.formVisible=!0},closeForm(){this.formVisible=!1},async submitForm(t){if(console.log("FORM SUBMIT:",t),this.editMode==="create"){const e=await this.recipeService.create(t),s=E.toEntityFromResponse(e);await this.recipeSupplyService.bulkCreate(s.id,t.supplies)}else console.log("EDIT MODE - ID:",t.id),await this.recipeSupplyService.deleteByRecipe(t.id),await this.recipeSupplyService.bulkCreate(t.id,t.supplies),await this.recipeService.update(t.id,t);await this.loadRecipes(),this.closeForm()},openDeleteDialog(t){this.selectedRecipe=t,this.deleteVisible=!0},async confirmDelete(){await this.recipeService.delete(this.selectedRecipe.id),await this.recipeSupplyService.deleteByRecipe(this.selectedRecipe.id),this.deleteVisible=!1,this.selectedRecipe=null,await this.loadRecipes()},getCurrentUserId(){}}},re={class:"recipes-view p-4"},pe={class:"recipes-header flex flex-column sm:flex-row justify-content-between sm:align-items-center flex-wrap gap-3 sm:gap-4 mb-4"},ce={class:"recipes-header__top"},ue={class:"text-2xl font-semibold mr-2"},de={class:"recipes-header__middle flex flex-row flex-wrap align-items-center gap-2 sm:gap-5"},me={class:"flex align-items-center gap-2"},ye={class:"recipes-header__actions"},_e={key:1,class:"recipes-grid"},he=["src"],fe={class:"recipe-card__actions"};function be(t,e,s,u,i,o){var x;const y=a("pv-input-text"),h=a("pv-input-switch"),f=a("pv-button"),b=a("empty-section"),g=a("SupplySelector"),l=a("add-and-edit-form"),d=a("create-and-edit"),B=a("DeleteConfirmation");return c(),_("div",re,[p("div",pe,[p("div",ce,[p("h2",ue,v(t.$t("recipes.title")),1)]),p("div",de,[n(y,{modelValue:i.search,"onUpdate:modelValue":e[0]||(e[0]=r=>i.search=r),placeholder:"Search recipes...",class:"w-full sm:w-30rem"},null,8,["modelValue"]),p("div",me,[e[5]||(e[5]=p("label",{for:"sortByPrice",class:"text-sm text-color-secondary"},"Sort by price",-1)),n(h,{modelValue:i.sortByPrice,"onUpdate:modelValue":e[1]||(e[1]=r=>i.sortByPrice=r),inputId:"sortByPrice"},null,8,["modelValue"])])]),p("div",ye,[n(f,{label:"Create",icon:"pi pi-plus-circle",onClick:o.openCreateDialog,class:"green-button w-full sm:w-auto font-semibold px-3 py-2"},null,8,["onClick"])])]),o.filteredRecipes.length===0?(c(),S(b,{key:0},{icon:m(()=>e[6]||(e[6]=[p("i",{class:"pi pi-clipboard",style:{"font-size":"3rem",color:"#bcbcbc"}},null,-1)])),default:m(()=>[e[7]||(e[7]=V(" You currently have no recipes registered. Create a new recipe to start organizing your preparations and better manage your ingredients from this section. "))]),_:1})):(c(),_("div",_e,[(c(!0),_(U,null,k(o.filteredRecipes,r=>(c(),_("div",{key:r.id,class:"recipe-card"},[p("img",{src:r.image_url,alt:"Dish image"},null,8,he),p("h3",null,v(r.name),1),p("p",null,"Total cost: S/."+v(r.total_price),1),p("div",fe,[n(f,{icon:"pi pi-pencil",onClick:R=>o.openEditDialog(r),outlined:""},null,8,["onClick"]),n(f,{icon:"pi pi-trash",severity:"danger",onClick:R=>o.openDeleteDialog(r),outlined:""},null,8,["onClick"])])]))),128))])),n(d,{modelValue:i.formVisible,"onUpdate:modelValue":e[2]||(e[2]=r=>i.formVisible=r),mode:i.editMode,createTitle:"Create Recipe",editTitle:"Edit Recipe",onClose:o.closeForm},{default:m(()=>[n(l,{schema:o.formSchema,initialData:i.formModel,mode:i.editMode,onSubmit:o.submitForm},{extension:m(({form:r})=>[e[8]||(e[8]=p("h4",{class:"mt-4 mb-2"},"Recipe Supplies",-1)),n(g,{modelValue:r.supplies,"onUpdate:modelValue":R=>r.supplies=R},null,8,["modelValue","onUpdate:modelValue"])]),_:1},8,["schema","initialData","mode","onSubmit"])]),_:1},8,["modelValue","mode","onClose"]),n(B,{modelValue:i.deleteVisible,"onUpdate:modelValue":e[3]||(e[3]=r=>i.deleteVisible=r),label:(x=i.selectedRecipe)==null?void 0:x.name,onConfirm:o.confirmDelete,onCancel:e[4]||(e[4]=r=>i.deleteVisible=!1)},null,8,["modelValue","label","onConfirm"])])}const Ce=w(ae,[["render",be],["__scopeId","data-v-478c67b0"]]);export{Ce as default};
