import{D as T,E as N}from"./delete.component-BUNhCD77.js";import{B as Q}from"./base-modal.component-B6uGyS4_.js";import{_ as C,E as q,c as v,a as h,z as B,g as p,o as c,L as I,M as j,d as y,b as r,F as k,j as D,e as w,t as d,n as U,f as a,N as L,i as R}from"./index-BPx0zh6T.js";import{S as A}from"./supply.service-CTib3cY-.js";import{S as O}from"./supply.assembler-CSpomLG2.js";import{R as z,a as G}from"./recipe-supply.service-BBGRWTm9.js";const Y={name:"CreateAndEdit",components:{PvButton:q,BaseModal:Q},props:{modelValue:{type:Boolean,required:!0},mode:{type:String,default:"create"},createTitle:{type:String,default:"Create"},editTitle:{type:String,default:"Edit"}},emits:["update:modelValue","close","save"],computed:{internalVisible:{get(){return this.modelValue},set(i){this.$emit("update:modelValue",i)}}}};function H(i,e,s,u,t,o){const m=p("BaseModal");return c(),v(m,{modelValue:o.internalVisible,"onUpdate:modelValue":e[0]||(e[0]=_=>o.internalVisible=_),title:s.mode==="create"?s.createTitle:s.editTitle,onClose:e[1]||(e[1]=_=>i.$emit("close"))},{default:h(()=>[B(i.$slots,"default")]),_:3},8,["modelValue","title"])}const J=C(Y,[["render",H]]),K={name:"AddAndEditForm",components:{PvInputNumber:j,PvInputText:I},props:{schema:{type:Array,required:!0},initialData:{type:Object,default:()=>({})},mode:{type:String,default:"create"}},emits:["submit"],data(){return{form:{...this.initialData},errors:{}}},watch:{initialData:{handler(i){this.form={...i},this.errors={}},deep:!0}},methods:{validate(){const i={};return this.schema.forEach(e=>{const s=this.form[e.name];e.type==="number"?(s==null||s===""||Number(s)<=0)&&(i[e.name]="Required"):e.type!=="boolean"&&(!s||s.toString().trim()==="")&&(i[e.name]="Required")}),this.errors=i,Object.keys(i).length===0},handleSubmit(){this.validate()&&this.$emit("submit",this.form)},handleUpload(i,e){const s=i.files[0];console.log("Upload triggered:",i.files),console.log("Sending to Cloudinary:"),console.log("Upload preset:","uitopic"),console.log("File:",s.name);const u=new FormData;u.append("file",s),u.append("upload_preset","uitopic"),fetch("https://api.cloudinary.com/v1_1/dvspiemtu/image/upload",{method:"POST",body:u}).then(t=>t.json()).then(t=>{console.log("Image uploaded:",t.secure_url),this.form[e]=t.secure_url}).catch(t=>{console.error("Upload failed:",t)})}}},W=["for"],X={key:4,class:"mt-3"},Z=["src"],$={key:5,class:"p-error"},ee={class:"flex justify-content-end mt-4"};function te(i,e,s,u,t,o){const m=p("pv-input-text"),_=p("pv-input-number"),b=p("pv-input-switch"),S=p("FileUpload"),g=p("pv-button");return c(),y("form",{onSubmit:e[0]||(e[0]=L((...l)=>o.handleSubmit&&o.handleSubmit(...l),["prevent"]))},[(c(!0),y(k,null,D(s.schema,l=>(c(),y("div",{key:l.name,class:"p-field mb-3"},[r("label",{for:l.name,class:"block mb-1"},d(l.label),9,W),l.type==="text"?(c(),v(m,{key:0,modelValue:t.form[l.name],"onUpdate:modelValue":f=>t.form[l.name]=f,id:l.name,placeholder:l.placeholder,class:U(["w-full",{"p-invalid":t.errors[l.name]}])},null,8,["modelValue","onUpdate:modelValue","id","placeholder","class"])):l.type==="number"?(c(),v(_,{key:1,modelValue:t.form[l.name],"onUpdate:modelValue":f=>t.form[l.name]=f,id:l.name,placeholder:l.placeholder,mode:l.format==="currency"?"currency":"decimal",currency:l.format==="currency"?"PEN":null,locale:"es-PE",useGrouping:!0,minFractionDigits:l.format==="currency"?2:0,maxFractionDigits:l.format==="currency"?2:0,class:U(["w-full",{"p-invalid":t.errors[l.name]}])},null,8,["modelValue","onUpdate:modelValue","id","placeholder","mode","currency","minFractionDigits","maxFractionDigits","class"])):l.type==="boolean"?(c(),v(b,{key:2,modelValue:t.form[l.name],"onUpdate:modelValue":f=>t.form[l.name]=f,id:l.name},null,8,["modelValue","onUpdate:modelValue","id"])):w("",!0),l.type==="file"?(c(),v(S,{key:3,name:"file",mode:"basic",customUpload:"",auto:"",accept:"image/*",class:"green-button",onUploader:f=>o.handleUpload(f,l.name)},null,8,["onUploader"])):w("",!0),l.type==="file"&&t.form[l.name]?(c(),y("div",X,[r("img",{src:t.form[l.name],alt:"Preview",style:{"max-width":"100%","border-radius":"10px"}},null,8,Z)])):w("",!0),t.errors[l.name]?(c(),y("small",$,d(t.errors[l.name]),1)):w("",!0)]))),128)),B(i.$slots,"extension",{form:t.form}),r("div",ee,[a(g,{label:s.mode==="create"?"Save":"Update",icon:"pi pi-check",type:"submit",class:"green-button"},null,8,["label"])])],32)}const ie=C(K,[["render",te]]),le={name:"SupplySelector",props:{modelValue:{type:Array,default:()=>[]}},emits:["update:modelValue"],data(){return{availableSupplies:[],selectedSupply:null,selectedQuantity:null,internalValue:[...this.modelValue||[]]}},watch:{internalValue:{handler(i){this.$emit("update:modelValue",i)},deep:!0}},computed:{supplies:{get(){return this.modelValue},set(i){this.$emit("update:modelValue",i)}}},async created(){const e=await new A().getAll();this.availableSupplies=O.toEntitiesFromResponse(e)},methods:{addSupply(){!this.internalValue.some(e=>{var s;return e.supply_id===((s=this.selectedSupply)==null?void 0:s.id)})&&this.selectedQuantity>0&&this.internalValue.push({supply_id:this.selectedSupply.id,quantity:this.selectedQuantity}),this.selectedSupply=null,this.selectedQuantity=null},removeSupply(i){this.internalValue.splice(i,1)},getSupplyName(i){const e=this.availableSupplies.find(s=>s.id===i);return e?e.name:"Unknown"}}},se={class:"supply-selector"},oe={class:"flex align-items-center gap-2 mb-3"};function ne(i,e,s,u,t,o){const m=p("pv-select"),_=p("pv-input-number"),b=p("pv-button"),S=p("pv-column"),g=p("pv-data-table");return c(),y("div",se,[r("div",oe,[a(m,{modelValue:t.selectedSupply,"onUpdate:modelValue":e[0]||(e[0]=l=>t.selectedSupply=l),options:t.availableSupplies,placeholder:"Select supply",class:"w-full"},{option:h(({option:l})=>[R(d(l.name),1)]),value:h(({value:l})=>[R(d((l==null?void 0:l.name)||"Select supply"),1)]),_:1},8,["modelValue","options"]),a(_,{modelValue:t.selectedQuantity,"onUpdate:modelValue":e[1]||(e[1]=l=>t.selectedQuantity=l),placeholder:"Qty",class:"w-6rem",inputClass:"w-full"},null,8,["modelValue"]),a(b,{icon:"pi pi-plus-circle",onClick:o.addSupply,class:"green-button",disabled:!t.selectedSupply||!t.selectedQuantity||t.selectedQuantity<=0},null,8,["onClick","disabled"])]),a(g,{value:t.internalValue,class:"w-full"},{default:h(()=>[a(S,{field:"supply_id",header:"ID"}),a(S,{field:"description",header:"Supply"},{body:h(l=>[R(d(o.getSupplyName(l.data.supply_id)),1)]),_:1}),a(S,{field:"quantity",header:"Quantity"}),a(S,{header:"Actions"},{body:h(l=>[a(b,{icon:"pi pi-trash",onClick:f=>o.removeSupply(l.index),severity:"danger",text:""},null,8,["onClick"])]),_:1})]),_:1},8,["value"])])}const re=C(le,[["render",ne]]);class ae{constructor({id:e,name:s,description:u,total_price:t,image_url:o,user_id:m}){this.id=e,this.name=s,this.description=u,this.total_price=t,this.image_url=o,this.user_id=m}}class x{static toEntityFromResource(e){return new ae({...e})}static toEntitiesFromResponse(e){return(Array.isArray(e.data)?e.data:e.data.recipes||[]).map(u=>this.toEntityFromResource(u))}static toEntityFromResponse(e){return!e||!e.data?null:this.toEntityFromResource(e.data)}}class pe{constructor(e){this.id=e.id,this.recipe_id=e.recipe_id,this.supply_id=e.supply_id,this.quantity=e.quantity}getQuantityLabel(){return`${this.quantity} unit(s)`}}class E{static toEntity(e){return new pe(e)}static toEntities(e){return e.map(s=>this.toEntity(s))}static toEntitiesFromResponse(e){return this.toEntities(e.data)}static toEntityFromResponse(e){return this.toEntity(e.data)}}const ce={name:"RestaurantRecipesOverview",components:{EmptySection:N,CreateAndEdit:J,AddAndEditForm:ie,DeleteConfirmation:T,SupplySelector:re},data(){return{recipes:[],search:"",formVisible:!1,editMode:"create",formModel:{},selectedRecipe:null,deleteVisible:!1,recipeService:new G,sortByPrice:!1,recipeSupplyService:new z,detailsVisible:!1,supplyService:new A,allSupplies:[]}},computed:{filteredRecipes(){let i=this.recipes.filter(e=>e.name.toLowerCase().includes(this.search.toLowerCase()));return this.sortByPrice?i.sort((e,s)=>e.total_price-s.total_price):i},formSchema(){return[{name:"name",label:"Name",type:"text",placeholder:"Recipe name"},{name:"description",label:"Description",type:"text",placeholder:"Short description"},{name:"total_price",label:"Total Price (S/.)",type:"number",placeholder:"e.g. 29.90",format:"currency"},{name:"image_url",label:"Dish Image",placeholder:"Upload an image",type:"file"}]}},async created(){this.allSupplies=await this.loadAllSupplies(),await this.loadRecipes()},methods:{async loadAllSupplies(){return(await this.supplyService.getAll()).data},async loadRecipes(){const i=await this.recipeService.getAll(),e=x.toEntitiesFromResponse(i),s=await Promise.all(e.map(async u=>{const t=await this.recipeSupplyService.getByRecipe(u.id),o=E.toEntitiesFromResponse(t);return{...u,supplies:o}}));this.recipes=s},openCreateDialog(){this.editMode="create",this.formModel={supplies:[],user_id:1},this.formVisible=!0},async openEditDialog(i){const e=await this.recipeSupplyService.getByRecipe(i.id),s=E.toEntitiesFromResponse(e);this.formModel={...i,supplies:s},this.editMode="edit",this.formVisible=!0},closeForm(){this.formVisible=!1},async submitForm(i){if(this.editMode==="create"){const e=await this.recipeService.create(i),s=x.toEntityFromResponse(e);await this.recipeSupplyService.bulkCreate(s.id,i.supplies)}else await this.recipeSupplyService.deleteByRecipe(i.id),await this.recipeSupplyService.bulkCreate(i.id,i.supplies),await this.recipeService.update(i.id,i);await this.loadRecipes(),this.closeForm()},openDeleteDialog(i){this.selectedRecipe=i,this.deleteVisible=!0},async confirmDelete(){await this.recipeService.delete(this.selectedRecipe.id),await this.recipeSupplyService.deleteByRecipe(this.selectedRecipe.id),this.deleteVisible=!1,this.selectedRecipe=null,await this.loadRecipes()},async recipeDetails(i){const e=await this.recipeService.getById(i.id),s=x.toEntityFromResponse(e),u=await this.recipeSupplyService.getByRecipe(i.id),o=E.toEntitiesFromResponse(u).map(m=>{const _=this.allSupplies.find(b=>b.id===m.supply_id);return{...m,supply:_}});this.selectedRecipe={...s,supplies:o},this.detailsVisible=!0}}},ue={class:"recipes-view p-4"},de={class:"recipes-header flex flex-column sm:flex-row justify-content-between sm:align-items-center flex-wrap gap-3 sm:gap-4 mb-4"},me={class:"recipes-header__top"},ye={class:"text-2xl font-semibold mr-2"},he={class:"recipes-header__middle flex flex-row flex-wrap align-items-center gap-2 sm:gap-5"},_e={class:"flex align-items-center gap-2"},be={class:"recipes-header__actions"},fe={key:1,class:"recipes-grid"},Se=["onClick"],ve=["src"],ge={class:"recipe-card__actions"},Ve={class:"modal-content"},we=["src"];function Re(i,e,s,u,t,o){var F;const m=p("pv-input-text"),_=p("pv-input-switch"),b=p("pv-button"),S=p("empty-section"),g=p("SupplySelector"),l=p("add-and-edit-form"),f=p("create-and-edit"),P=p("DeleteConfirmation"),M=p("pv-dialog");return c(),y("div",ue,[r("div",de,[r("div",me,[r("h2",ye,d(i.$t("recipes.title")),1)]),r("div",he,[a(m,{modelValue:t.search,"onUpdate:modelValue":e[0]||(e[0]=n=>t.search=n),placeholder:"Search recipes...",class:"w-full sm:w-30rem"},null,8,["modelValue"]),r("div",_e,[e[6]||(e[6]=r("label",{for:"sortByPrice",class:"text-sm text-color-secondary"},"Sort by price",-1)),a(_,{modelValue:t.sortByPrice,"onUpdate:modelValue":e[1]||(e[1]=n=>t.sortByPrice=n),inputId:"sortByPrice"},null,8,["modelValue"])])]),r("div",be,[a(b,{label:"Create",icon:"pi pi-plus-circle",onClick:o.openCreateDialog,class:"green-button w-full sm:w-auto font-semibold px-3 py-2"},null,8,["onClick"])])]),o.filteredRecipes.length===0?(c(),v(S,{key:0},{icon:h(()=>e[7]||(e[7]=[r("i",{class:"pi pi-clipboard",style:{"font-size":"3rem",color:"#bcbcbc"}},null,-1)])),default:h(()=>[e[8]||(e[8]=R(" You currently have no recipes registered. Create a new recipe to start organizing your preparations and better manage your ingredients from this section. "))]),_:1})):(c(),y("div",fe,[(c(!0),y(k,null,D(o.filteredRecipes,n=>(c(),y("div",{key:n.id,class:"recipe-card",onClick:V=>o.recipeDetails(n)},[r("img",{src:n.image_url,alt:"Dish image"},null,8,ve),r("h3",null,d(n.name),1),r("p",null,"Total cost: S/."+d(n.total_price),1),r("div",ge,[a(b,{icon:"pi pi-pencil",onClick:V=>o.openEditDialog(n),outlined:""},null,8,["onClick"]),a(b,{icon:"pi pi-trash",severity:"danger",onClick:V=>o.openDeleteDialog(n),outlined:""},null,8,["onClick"])])],8,Se))),128))])),a(f,{modelValue:t.formVisible,"onUpdate:modelValue":e[2]||(e[2]=n=>t.formVisible=n),mode:t.editMode,createTitle:"Create Recipe",editTitle:"Edit Recipe",onClose:o.closeForm},{default:h(()=>[a(l,{schema:o.formSchema,initialData:t.formModel,mode:t.editMode,onSubmit:o.submitForm},{extension:h(({form:n})=>[e[9]||(e[9]=r("h4",{class:"mt-4 mb-2"},"Recipe Supplies",-1)),a(g,{modelValue:n.supplies,"onUpdate:modelValue":V=>n.supplies=V},null,8,["modelValue","onUpdate:modelValue"])]),_:1},8,["schema","initialData","mode","onSubmit"])]),_:1},8,["modelValue","mode","onClose"]),a(P,{modelValue:t.deleteVisible,"onUpdate:modelValue":e[3]||(e[3]=n=>t.deleteVisible=n),label:(F=t.selectedRecipe)==null?void 0:F.name,onConfirm:o.confirmDelete,onCancel:e[4]||(e[4]=n=>t.deleteVisible=!1)},null,8,["modelValue","label","onConfirm"]),a(M,{visible:t.detailsVisible,"onUpdate:visible":e[5]||(e[5]=n=>t.detailsVisible=n),modal:"",style:{width:"auto",height:"auto"},closable:!0},{default:h(()=>[r("div",Ve,[r("h3",null,d(t.selectedRecipe.name),1),r("p",null,d(t.selectedRecipe.description),1),r("img",{src:t.selectedRecipe.image_url,alt:"Recipe image",style:{"max-width":"100%"}},null,8,we),r("p",null,"Total Price: S/. "+d(t.selectedRecipe.total_price),1),e[10]||(e[10]=r("h4",null,"Supplies:",-1)),r("ul",null,[(c(!0),y(k,null,D(t.selectedRecipe.supplies,n=>(c(),y("li",{key:n.supply.id},d(n.supply.name)+" - "+d(n.quantity)+" unit(s) ",1))),128))])])]),_:1},8,["visible"])])}const Ue=C(ce,[["render",Re],["__scopeId","data-v-2b3589e0"]]);export{Ue as default};
